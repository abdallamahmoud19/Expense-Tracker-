<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses - Expense Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="main-container">
        <div class="row g-0 h-100">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2">
                <div class="d-flex flex-column vh-100 navbar-custom glass-heavy">
                    <div class="p-3 text-center">
                        <h4 class="mb-0">üí∞ Expense Tracker</h4>
                    </div>
                    <nav class="flex-grow-1">
                        <ul class="nav nav-pills flex-column p-3">
                            <li class="nav-item mb-2">
                                <a href="/dashboard/view" class="nav-link">
                                    üìä Dashboard
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a href="/incomes/view" class="nav-link">
                                    üí∞ Incomes
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a href="/expenses/view" class="nav-link active">
                                    üí∏ Expenses
                                </a>
                            </li>
                            <li class="nav-item mt-auto">
                                <a href="#" onclick="logout()" class="nav-link">
                                    üö™ Logout
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <div class="content-wrapper p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h2 mb-1">üí∏ Expense Management</h1>
                        </div>
                        <button onclick="exportExpenses()" class="btn btn-outline-primary">
                            üìä Export Excel
                        </button>
                    </div>

                    <div id="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading expenses...</p>
                    </div>

                    <div id="error-message" class="alert alert-danger" style="display: none;" role="alert"></div>
                    <div id="success-message" class="alert alert-success" style="display: none;" role="alert"></div>

                    <!-- Add Expense Form -->
                    <div class="row mb-4">
                        <div class="col-lg-8 mx-auto">
                            <div class="card form-card glass">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="card-title mb-0" id="formTitle">üí∏ Add New Expense</h5>
                                </div>
                                <div class="card-body">
                                    <form id="expenseForm" onsubmit="submitExpenseForm(event)">
                                        <input type="hidden" id="expenseId" value="">
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="description" class="form-label">Description</label>
                                                <input id="description" class="form-control" placeholder="Expense description" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="amount" class="form-label">Amount ($)</label>
                                                <input id="amount" class="form-control" placeholder="0.00" type="number" step="0.01" min="0" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="categorySelect" class="form-label">Category</label>
                                                <select id="categorySelect" class="form-select" onchange="toggleCustomCategory()">
                                                    <option value="">Select category</option>
                                                    <option value="Food">Food & Dining</option>
                                                    <option value="Transportation">Transportation</option>
                                                    <option value="Shopping">Shopping</option>
                                                    <option value="Entertainment">Entertainment</option>
                                                    <option value="Bills">Bills & Utilities</option>
                                                    <option value="Healthcare">Healthcare</option>
                                                    <option value="Education">Education</option>
                                                    <option value="Travel">Travel</option>
                                                    <option value="Work">Work</option>
                                                    <option value="custom">Other (Enter custom)</option>
                                                </select>
                                                <input id="customCategory" class="form-control mt-2" style="display: none;"
                                                       placeholder="Enter custom category" />
                                            </div>
                                            <div class="col-md-6">
                                                <label for="icon" class="form-label">Icon</label>
                                                <select id="icon" class="form-select">
                                                    <option value="üí∏">üí∏ Money Out</option>
                                                    <option value="üçï">üçï Food</option>
                                                    <option value="üöó">üöó Transport</option>
                                                    <option value="üõçÔ∏è">üõçÔ∏è Shopping</option>
                                                    <option value="üé¨">üé¨ Entertainment</option>
                                                    <option value="‚ö°">‚ö° Bills</option>
                                                    <option value="üè•">üè• Healthcare</option>
                                                    <option value="üìö">üìö Education</option>
                                                    <option value="‚úàÔ∏è">‚úàÔ∏è Travel</option>
                                                    <option value="üíº">üíº Work</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="date" class="form-label">Date</label>
                                                <input id="date" class="form-control" type="date" required>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                                <span id="submitText">Add Expense</span>
                                                <span id="submitSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;" role="status"></span>
                                            </button>
                                            <button type="reset" class="btn btn-secondary" onclick="resetForm()">Clear Form</button>
                                            <button type="button" class="btn btn-outline-secondary" id="cancelBtn" onclick="cancelEdit()" style="display: none;">Cancel Edit</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="expenses-content" style="display: none;">
                        <!-- Chart Section -->
                        <div class="row mb-4">
                            <div class="col-lg-8 mx-auto">
                                <div class="card chart-card glass">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Expense Overview (Last 30 Days)</h5>
                                    </div>
                                    <div class="card-body">
                                        <div style="position: relative; height: 300px;">
                                            <canvas id="expenseChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Expenses List -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card glass">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Your Expenses</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="expensesList">
                                            <!-- Expenses will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
        }

        function hideMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login/view';
        }

        function setSubmitLoading(loading) {
            const btn = document.getElementById('submitBtn');
            const text = document.getElementById('submitText');
            const spinner = document.getElementById('submitSpinner');
            
            btn.disabled = loading;
            text.style.display = loading ? 'none' : 'inline';
            spinner.style.display = loading ? 'inline-block' : 'none';
        }

        function resetForm() {
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseId').value = '';
            document.getElementById('formTitle').textContent = 'üí∏ Add New Expense';
            document.getElementById('submitText').textContent = 'Add Expense';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // Reset custom category if visible
            const categorySelect = document.getElementById('categorySelect');
            const customCategory = document.getElementById('customCategory');
            categorySelect.value = '';
            customCategory.style.display = 'none';
            customCategory.value = '';
        }

        function cancelEdit() {
            resetForm();
        }

        function editExpense(id, description, amount, category, icon, date) {
            document.getElementById('expenseId').value = id;
            document.getElementById('description').value = description;
            document.getElementById('amount').value = amount;
            document.getElementById('icon').value = icon;
            document.getElementById('date').value = date;
            
            // Handle category (check if it's a predefined option or custom)
            const categorySelect = document.getElementById('categorySelect');
            const customCategory = document.getElementById('customCategory');
            const predefinedCategories = ['Food', 'Transportation', 'Shopping', 'Entertainment', 'Bills', 'Healthcare', 'Education', 'Travel', 'Work'];
            
            if (predefinedCategories.includes(category)) {
                categorySelect.value = category;
                customCategory.style.display = 'none';
                customCategory.value = '';
            } else {
                categorySelect.value = 'custom';
                customCategory.style.display = 'block';
                customCategory.value = category;
            }
            
            document.getElementById('formTitle').textContent = '‚úèÔ∏è Edit Expense';
            document.getElementById('submitText').textContent = 'Update Expense';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            
            // Scroll to form
            document.getElementById('expenseForm').scrollIntoView({ behavior: 'smooth' });
        }

        function submitExpenseForm(event) {
            const expenseId = document.getElementById('expenseId').value;
            if (expenseId) {
                updateExpense(event);
            } else {
                addExpense(event);
            }
        }

        async function loadExpenses() {
            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = "/login/view";
                return;
            }

            try {
                const res = await fetch("/expense/getall", {
                    headers: {"Authorization": "Bearer " + token}
                });

                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = '/login/view';
                        return;
                    }
                    throw new Error('Failed to load expenses');
                }

                const data = await res.json();
                const list = document.getElementById("expensesList");
                list.innerHTML = "";

                if (data && data.length > 0) {
                    data.forEach(expense => {
                        const item = document.createElement('div');
                        item.className = 'card mb-2 expense-item glass-light';
                        item.innerHTML = `
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${expense.icon} ${expense.description}</div>
                                    <small class="text-muted">${expense.category} ‚Ä¢ ${formatDate(expense.date)}</small>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <span class="badge bg-danger fs-6">${formatCurrency(expense.amount)}</span>
                                    <div class="btn-group" role="group">
                                        <button onclick="editExpense(${expense.id}, '${expense.description}', ${expense.amount}, '${expense.category}', '${expense.icon}', '${expense.date}')" class="btn btn-sm btn-outline-primary">Edit</button>
                                        <button onclick="deleteExpense(${expense.id})" class="btn btn-sm btn-outline-danger">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                } else {
                    list.innerHTML = '<div class="alert alert-info glass">No expenses found. Add your first expense above!</div>';
                }

                // Create expense overview chart
                createExpenseChart(data);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('expenses-content').style.display = 'block';

            } catch (error) {
                showError("Failed to load expenses. Please try again.");
                console.error('Load expenses error:', error);
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function addExpense(event) {
            event.preventDefault();
            hideMessages();
            setSubmitLoading(true);

            const token = localStorage.getItem("token");

            // Get category value (either from select or custom input)
            const categorySelect = document.getElementById("categorySelect");
            const customCategory = document.getElementById("customCategory");
            let categoryValue = categorySelect.value;
            
            if (categorySelect.value === "custom") {
                categoryValue = customCategory.value.trim();
                if (!categoryValue) {
                    showError("Please enter a custom category.");
                    setSubmitLoading(false);
                    return;
                }
            } else if (!categoryValue) {
                showError("Please select or enter an expense category.");
                setSubmitLoading(false);
                return;
            }

            const expense = {
                description: document.getElementById("description").value,
                icon: document.getElementById("icon").value,
                amount: parseFloat(document.getElementById("amount").value),
                category: categoryValue,
                date: document.getElementById("date").value
            };

            try {
                const res = await fetch("/expense/add", {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + token,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(expense)
                });

                if (res.ok) {
                    showSuccess("Expense added successfully!");
                    resetForm();
                    loadExpenses();
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    showError(errorData.message || "Failed to add expense. Please try again.");
                }
            } catch (error) {
                showError("Network error. Please try again.");
                console.error('Add expense error:', error);
            } finally {
                setSubmitLoading(false);
            }
        }

        async function updateExpense(event) {
            event.preventDefault();
            hideMessages();
            setSubmitLoading(true);

            const token = localStorage.getItem("token");
            const expenseId = document.getElementById('expenseId').value;

            // Get category value (either from select or custom input)
            const categorySelect = document.getElementById("categorySelect");
            const customCategory = document.getElementById("customCategory");
            let categoryValue = categorySelect.value;
            
            if (categorySelect.value === "custom") {
                categoryValue = customCategory.value.trim();
                if (!categoryValue) {
                    showError("Please enter a custom category.");
                    setSubmitLoading(false);
                    return;
                }
            } else if (!categoryValue) {
                showError("Please select or enter an expense category.");
                setSubmitLoading(false);
                return;
            }

            const expense = {
                description: document.getElementById("description").value,
                icon: document.getElementById("icon").value,
                amount: parseFloat(document.getElementById("amount").value),
                category: categoryValue,
                date: document.getElementById("date").value
            };

            try {
                const res = await fetch(`/expense/update/${expenseId}`, {
                    method: "PUT",
                    headers: {
                        "Authorization": "Bearer " + token,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(expense)
                });

                if (res.ok) {
                    showSuccess("Expense updated successfully!");
                    resetForm();
                    loadExpenses();
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    showError(errorData.message || "Failed to update expense. Please try again.");
                }
            } catch (error) {
                showError("Network error. Please try again.");
                console.error('Update expense error:', error);
            } finally {
                setSubmitLoading(false);
            }
        }

        async function deleteExpense(id) {
            if (!confirm('Are you sure you want to delete this expense?')) {
                return;
            }

            const token = localStorage.getItem("token");

            try {
                const res = await fetch(`/expense/delete/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": "Bearer " + token }
                });

                if (res.ok) {
                    showSuccess("Expense deleted successfully!");
                    loadExpenses();
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    showError(errorData.message || "Failed to delete expense. Please try again.");
                }
            } catch (error) {
                showError("Network error. Please try again.");
                console.error('Delete expense error:', error);
            }
        }

        async function exportExpenses() {
            const token = localStorage.getItem("token");

            try {
                const res = await fetch("/expense/export", {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (res.ok) {
                    const blob = await res.blob();
                    const link = document.createElement("a");
                    link.href = window.URL.createObjectURL(blob);
                    link.download = "expenses.xlsx";
                    link.click();
                    showSuccess("Expenses exported successfully!");
                } else {
                    showError("Failed to export expenses. Please try again.");
                }
            } catch (error) {
                showError("Network error. Please try again.");
                console.error('Export expenses error:', error);
            }
        }

        function toggleCustomCategory() {
            const categorySelect = document.getElementById("categorySelect");
            const customCategory = document.getElementById("customCategory");
            
            if (categorySelect.value === "custom") {
                customCategory.style.display = "block";
                customCategory.required = true;
                categorySelect.required = false;
            } else {
                customCategory.style.display = "none";
                customCategory.required = false;
                categorySelect.required = true;
                customCategory.value = "";
            }
        }

        function createExpenseChart(expenses) {
            // Group expenses by day for the last 30 days
            const dailyData = {};
            const currentDate = new Date();
            
            // Initialize last 30 days
            for (let i = 29; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - i);
                const dayKey = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                dailyData[dayKey] = 0;
            }

            // Aggregate expense data by day
            if (expenses && expenses.length > 0) {
                expenses.forEach(expense => {
                    const expenseDate = new Date(expense.date);
                    const dayKey = expenseDate.toISOString().split('T')[0];
                    if (dailyData.hasOwnProperty(dayKey)) {
                        dailyData[dayKey] += expense.amount;
                    }
                });
            }

            const labels = Object.keys(dailyData).map(key => {
                const date = new Date(key);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const data = Object.values(dailyData);

            const ctx = document.getElementById('expenseChart');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Expenses',
                        data: data,
                        backgroundColor: '#FF3B30',
                        borderColor: '#FF1744',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                },
                                color: '#FFFFFF'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#FFFFFF'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Expense: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        window.onload = function() {
            // Set default date to today
            document.getElementById("date").value = new Date().toISOString().split('T')[0];
            loadExpenses();
        };
    </script>
</body>
</html>
