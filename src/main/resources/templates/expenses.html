<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses - Expense Tracker</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∏ Expense Management</h1>
        </div>
        
        <nav class="nav-menu">
            <ul>
                <li><a href="/dashboard/view">üìä Dashboard</a></li>
                <li><a href="/incomes/view">üí∞ Incomes</a></li>
                <li><a href="/expenses/view" class="active">üí∏ Expenses</a></li>
                <li><a href="#" onclick="logout()">üö™ Logout</a></li>
            </ul>
        </nav>

        <div class="content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>Your Expenses</h2>
                <button onclick="exportExpenses()" class="btn btn-secondary">üìä Export Excel</button>
            </div>

            <div id="loading" style="text-align: center; padding: 50px;">
                <p>Loading expenses...</p>
            </div>

            <div id="error-message" class="alert alert-error" style="display: none;"></div>
            <div id="success-message" class="alert alert-success" style="display: none;"></div>

            <div class="chart-container" style="max-width: 600px; margin: 0 auto 30px auto;">
                <h3>üí∏ Add New Expense</h3>
                <form id="expenseForm" onsubmit="addExpense(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="description">Description</label>
                            <input id="description" class="form-control" placeholder="Expense description" required>
                        </div>
                        <div class="form-group">
                            <label for="amount">Amount ($)</label>
                            <input id="amount" class="form-control" placeholder="0.00" type="number" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="categorySelect" class="form-control" onchange="toggleCustomCategory()">
                                <option value="">Select category</option>
                                <option value="Food">Food & Dining</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Bills">Bills & Utilities</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Education">Education</option>
                                <option value="Travel">Travel</option>
                                <option value="Work">Work</option>
                                <option value="custom">Other (Enter custom)</option>
                            </select>
                            <input id="customCategory" class="form-control" style="display: none; margin-top: 10px;"
                                   placeholder="Enter custom category" />
                        </div>
                        <div class="form-group">
                            <label for="icon">Icon</label>
                            <select id="icon" class="form-control">
                                <option value="üí∏">üí∏ Money Out</option>
                                <option value="üçï">üçï Food</option>
                                <option value="üöó">üöó Transport</option>
                                <option value="üõçÔ∏è">üõçÔ∏è Shopping</option>
                                <option value="üé¨">üé¨ Entertainment</option>
                                <option value="‚ö°">‚ö° Bills</option>
                                <option value="üè•">üè• Healthcare</option>
                                <option value="üìö">üìö Education</option>
                                <option value="‚úàÔ∏è">‚úàÔ∏è Travel</option>
                                <option value="üíº">üíº Work</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input id="date" class="form-control" type="date" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="addBtn">
                            <span id="addText">Add Expense</span>
                            <span id="addSpinner" style="display: none;">Adding...</span>
                        </button>
                        <button type="reset" class="btn btn-secondary">Clear Form</button>
                    </div>
                </form>
            </div>

            <div id="expenses-content" style="display: none;">
                <div class="chart-container" style="margin-bottom: 30px; max-width: 600px; height: 300px;">
                    <h3>Expense Overview (Last 30 Days)</h3>
                    <canvas id="expenseChart"></canvas>
                </div>

                <ul id="expensesList" class="data-list">
                    <!-- Expenses will be populated here -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
        }

        function hideMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login/view';
        }

        function setAddLoading(loading) {
            const btn = document.getElementById('addBtn');
            const text = document.getElementById('addText');
            const spinner = document.getElementById('addSpinner');
            
            btn.disabled = loading;
            text.style.display = loading ? 'none' : 'inline';
            spinner.style.display = loading ? 'inline' : 'none';
        }

        async function loadExpenses() {
            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = "/login/view";
                return;
            }

            try {
                const res = await fetch("/expense/getall", {
                    headers: {"Authorization": "Bearer " + token}
                });

                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = '/login/view';
                        return;
                    }
                    throw new Error('Failed to load expenses');
                }

                const data = await res.json();
                const list = document.getElementById("expensesList");
                list.innerHTML = "";

                if (data && data.length > 0) {
                    data.forEach(expense => {
                        const li = document.createElement('li');
                        li.className = 'data-item';
                        li.innerHTML = `
                            <div class="item-details">
                                <div class="item-description">${expense.icon} ${expense.description}</div>
                                <div class="item-meta">${expense.category} ‚Ä¢ ${formatDate(expense.date)}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div class="item-amount" style="color: #f44336;">${formatCurrency(expense.amount)}</div>
                                <div class="item-actions">
                                    <button onclick="deleteExpense(${expense.id})" class="btn btn-danger">Delete</button>
                                </div>
                            </div>
                        `;
                        list.appendChild(li);
                    });
                } else {
                    list.innerHTML = '<li class="data-item">No expenses found. Add your first expense below!</li>';
                }

                // Create expense overview chart
                createExpenseChart(data);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('expenses-content').style.display = 'block';

            } catch (error) {
                showError("Failed to load expenses. Please try again.");
                console.error('Load expenses error:', error);
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function addExpense(event) {
            event.preventDefault();
            hideMessages();
            setAddLoading(true);

            const token = localStorage.getItem("token");

            // Get category value (either from select or custom input)
            const categorySelect = document.getElementById("categorySelect");
            const customCategory = document.getElementById("customCategory");
            let categoryValue = categorySelect.value;
            
            if (categorySelect.value === "custom") {
                categoryValue = customCategory.value.trim();
                if (!categoryValue) {
                    showError("Please enter a custom category.");
                    setAddLoading(false);
                    return;
                }
            } else if (!categoryValue) {
                showError("Please select or enter an expense category.");
                setAddLoading(false);
                return;
            }

            const expense = {
                description: document.getElementById("description").value,
                icon: document.getElementById("icon").value,
                amount: parseFloat(document.getElementById("amount").value),
                category: categoryValue,
                date: document.getElementById("date").value
            };

            try {
                const res = await fetch("/expense/add", {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + token,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(expense)
                });

                if (res.ok) {
                    showSuccess("Expense added successfully!");
                    document.getElementById("expenseForm").reset();
                    // Set default date to today
                    document.getElementById("date").value = new Date().toISOString().split('T')[0];
                    loadExpenses();
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    showError(errorData.message || "Failed to add expense. Please try again.");
                }
            } catch (error) {
                showError("Network error. Please try again.");
                console.error('Add expense error:', error);
            } finally {
                setAddLoading(false);
            }
        }

        async function deleteExpense(id) {
            if (!confirm('Are you sure you want to delete this expense?')) {
                return;
            }

            const token = localStorage.getItem("token");

            try {
                const res = await fetch(`/expense/delete/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": "Bearer " + token }
                });

                if (res.ok) {
                    showSuccess("Expense deleted successfully!");
                    loadExpenses();
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    showError(errorData.message || "Failed to delete expense. Please try again.");
                }
            } catch (error) {
                showError("Network error. Please try again.");
                console.error('Delete expense error:', error);
            }
        }

        async function exportExpenses() {
            const token = localStorage.getItem("token");

            try {
                const res = await fetch("/expense/export", {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (res.ok) {
                    const blob = await res.blob();
                    const link = document.createElement("a");
                    link.href = window.URL.createObjectURL(blob);
                    link.download = "expenses.xlsx";
                    link.click();
                    showSuccess("Expenses exported successfully!");
                } else {
                    showError("Failed to export expenses. Please try again.");
                }
            } catch (error) {
                showError("Network error. Please try again.");
                console.error('Export expenses error:', error);
            }
        }

        function toggleCustomCategory() {
            const categorySelect = document.getElementById("categorySelect");
            const customCategory = document.getElementById("customCategory");
            
            if (categorySelect.value === "custom") {
                customCategory.style.display = "block";
                customCategory.required = true;
                categorySelect.required = false;
            } else {
                customCategory.style.display = "none";
                customCategory.required = false;
                categorySelect.required = true;
                customCategory.value = "";
            }
        }

        function createExpenseChart(expenses) {
            // Group expenses by day for the last 30 days
            const dailyData = {};
            const currentDate = new Date();
            
            // Initialize last 30 days
            for (let i = 29; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - i);
                const dayKey = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                dailyData[dayKey] = 0;
            }

            // Aggregate expense data by day
            if (expenses && expenses.length > 0) {
                expenses.forEach(expense => {
                    const expenseDate = new Date(expense.date);
                    const dayKey = expenseDate.toISOString().split('T')[0];
                    if (dailyData.hasOwnProperty(dayKey)) {
                        dailyData[dayKey] += expense.amount;
                    }
                });
            }

            const labels = Object.keys(dailyData).map(key => {
                const date = new Date(key);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const data = Object.values(dailyData);

            const ctx = document.getElementById('expenseChart');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Expenses',
                        data: data,
                        backgroundColor: '#f44336',
                        borderColor: '#da190b',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Expense: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        window.onload = function() {
            // Set default date to today
            document.getElementById("date").value = new Date().toISOString().split('T')[0];
            loadExpenses();
        };
    </script>
</body>
</html>
