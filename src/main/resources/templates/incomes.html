<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incomes - Expense Tracker</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Income Management</h1>
        </div>
        
        <nav class="nav-menu">
            <ul>
                <li><a href="/dashboard/view">üìä Dashboard</a></li>
                <li><a href="/incomes/view" class="active">üí∞ Incomes</a></li>
                <li><a href="/expenses/view">üí∏ Expenses</a></li>
                <li><a href="#" onclick="logout()">üö™ Logout</a></li>
            </ul>
        </nav>

        <div class="content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>Your Incomes</h2>
                <button onclick="exportIncomes()" class="btn btn-secondary">üìä Export Excel</button>
            </div>

            <div id="loading" style="text-align: center; padding: 50px;">
                <p>Loading incomes...</p>
            </div>

            <div id="error-message" class="alert alert-error" style="display: none;"></div>
            <div id="success-message" class="alert alert-success" style="display: none;"></div>

            <div class="chart-container" style="max-width: 600px; margin: 0 auto 30px auto;">
                <h3>üí∞ Add New Income</h3>
                <form id="incomeForm" onsubmit="addIncome(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="description">Description</label>
                            <input id="description" class="form-control" placeholder="Income description" required>
                        </div>
                        <div class="form-group">
                            <label for="amount">Amount ($)</label>
                            <input id="amount" class="form-control" placeholder="0.00" type="number" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="source">Source</label>
                            <select id="sourceSelect" class="form-control" onchange="toggleCustomSource()">
                                <option value="">Select income source</option>
                                <option value="Salary">Salary</option>
                                <option value="Freelance">Freelance</option>
                                <option value="Business">Business</option>
                                <option value="Investment">Investment</option>
                                <option value="Gift">Gift</option>
                                <option value="custom">Other (Enter custom)</option>
                            </select>
                            <input id="customSource" class="form-control" style="display: none; margin-top: 10px;"
                                   placeholder="Enter custom source" />
                        </div>
                        <div class="form-group">
                            <label for="icon">Icon</label>
                            <select id="icon" class="form-control">
                                <option value="üí∞">üí∞ Money</option>
                                <option value="üíµ">üíµ Dollar</option>
                                <option value="üíé">üíé Diamond</option>
                                <option value="üèÜ">üèÜ Trophy</option>
                                <option value="üíº">üíº Business</option>
                                <option value="üéÅ">üéÅ Gift</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input id="date" class="form-control" type="date" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="addBtn">
                            <span id="addText">Add Income</span>
                            <span id="addSpinner" style="display: none;">Adding...</span>
                        </button>
                        <button type="reset" class="btn btn-secondary">Clear Form</button>
                    </div>
                </form>
            </div>

            <div id="incomes-content" style="display: none;">
                <div class="chart-container" style="margin-bottom: 30px; max-width: 600px; height: 300px;">
                    <h3>Income Overview (Last 30 Days)</h3>
                    <canvas id="incomeChart"></canvas>
                </div>

                <ul id="incomesList" class="data-list">
                    <!-- Incomes will be populated here -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
        }

        function hideMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login/view';
        }

        function setAddLoading(loading) {
            const btn = document.getElementById('addBtn');
            const text = document.getElementById('addText');
            const spinner = document.getElementById('addSpinner');
            
            btn.disabled = loading;
            text.style.display = loading ? 'none' : 'inline';
            spinner.style.display = loading ? 'inline' : 'none';
        }

        async function loadIncomes() {
            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = "/login/view";
                return;
            }

            try {
                const res = await fetch("/income/getall", {
                    headers: {"Authorization": "Bearer " + token}
                });

                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = '/login/view';
                        return;
                    }
                    throw new Error('Failed to load incomes');
                }

                const data = await res.json();
                const list = document.getElementById("incomesList");
                list.innerHTML = "";

                if (data && data.length > 0) {
                    data.forEach(income => {
                        const li = document.createElement('li');
                        li.className = 'data-item';
                        li.innerHTML = `
                            <div class="item-details">
                                <div class="item-description">${income.icon} ${income.description}</div>
                                <div class="item-meta">${income.source} ‚Ä¢ ${formatDate(income.date)}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div class="item-amount">${formatCurrency(income.amount)}</div>
                                <div class="item-actions">
                                    <button onclick="deleteIncome(${income.id})" class="btn btn-danger">Delete</button>
                                </div>
                            </div>
                        `;
                        list.appendChild(li);
                    });
                } else {
                    list.innerHTML = '<li class="data-item">No incomes found. Add your first income below!</li>';
                }

                // Create income overview chart
                createIncomeChart(data);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('incomes-content').style.display = 'block';

            } catch (error) {
                showError("Failed to load incomes. Please try again.");
                console.error('Load incomes error:', error);
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function addIncome(event) {
            event.preventDefault();
            hideMessages();
            setAddLoading(true);

            const token = localStorage.getItem("token");

            // Get source value (either from select or custom input)
            const sourceSelect = document.getElementById("sourceSelect");
            const customSource = document.getElementById("customSource");
            let sourceValue = sourceSelect.value;
            
            if (sourceSelect.value === "custom") {
                sourceValue = customSource.value.trim();
                if (!sourceValue) {
                    showError("Please enter a custom source.");
                    setAddLoading(false);
                    return;
                }
            } else if (!sourceValue) {
                showError("Please select or enter an income source.");
                setAddLoading(false);
                return;
            }

            const income = {
                description: document.getElementById("description").value,
                icon: document.getElementById("icon").value,
                amount: parseFloat(document.getElementById("amount").value),
                source: sourceValue,
                date: document.getElementById("date").value
            };

            try {
                const res = await fetch("/income/add", {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + token,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(income)
                });

                if (res.ok) {
                    showSuccess("Income added successfully!");
                    document.getElementById("incomeForm").reset();
                    // Set default date to today
                    document.getElementById("date").value = new Date().toISOString().split('T')[0];
                    loadIncomes();
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    showError(errorData.message || "Failed to add income. Please try again.");
                }
            } catch (error) {
                showError("Network error. Please try again.");
                console.error('Add income error:', error);
            } finally {
                setAddLoading(false);
            }
        }

        async function deleteIncome(id) {
            if (!confirm('Are you sure you want to delete this income?')) {
                return;
            }

            const token = localStorage.getItem("token");

            try {
                const res = await fetch(`/income/delete/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": "Bearer " + token }
                });

                if (res.ok) {
                    showSuccess("Income deleted successfully!");
                    loadIncomes();
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    showError(errorData.message || "Failed to delete income. Please try again.");
                }
            } catch (error) {
                showError("Network error. Please try again.");
                console.error('Delete income error:', error);
            }
        }

        async function exportIncomes() {
            const token = localStorage.getItem("token");

            try {
                const res = await fetch("/income/export", {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (res.ok) {
                    const blob = await res.blob();
                    const link = document.createElement("a");
                    link.href = window.URL.createObjectURL(blob);
                    link.download = "incomes.xlsx";
                    link.click();
                    showSuccess("Incomes exported successfully!");
                } else {
                    showError("Failed to export incomes. Please try again.");
                }
            } catch (error) {
                showError("Network error. Please try again.");
                console.error('Export incomes error:', error);
            }
        }

        function toggleCustomSource() {
            const sourceSelect = document.getElementById("sourceSelect");
            const customSource = document.getElementById("customSource");
            
            if (sourceSelect.value === "custom") {
                customSource.style.display = "block";
                customSource.required = true;
                sourceSelect.required = false;
            } else {
                customSource.style.display = "none";
                customSource.required = false;
                sourceSelect.required = true;
                customSource.value = "";
            }
        }

        function createIncomeChart(incomes) {
            // Group incomes by day for the last 30 days
            const dailyData = {};
            const currentDate = new Date();
            
            // Initialize last 30 days
            for (let i = 29; i >= 0; i--) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() - i);
                const dayKey = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                dailyData[dayKey] = 0;
            }

            // Aggregate income data by day
            if (incomes && incomes.length > 0) {
                incomes.forEach(income => {
                    const incomeDate = new Date(income.date);
                    const dayKey = incomeDate.toISOString().split('T')[0];
                    if (dailyData.hasOwnProperty(dayKey)) {
                        dailyData[dayKey] += income.amount;
                    }
                });
            }

            const labels = Object.keys(dailyData).map(key => {
                const date = new Date(key);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const data = Object.values(dailyData);

            const ctx = document.getElementById('incomeChart');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Income',
                        data: data,
                        backgroundColor: '#4CAF50',
                        borderColor: '#45a049',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Income: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        window.onload = function() {
            // Set default date to today
            document.getElementById("date").value = new Date().toISOString().split('T')[0];
            loadIncomes();
        };
    </script>
</body>
</html>
